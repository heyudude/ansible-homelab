---
- hosts: spmaxi
  gather_facts: no

  vars_files:
    - vars.yml

  vars:
    # Сколько нужно создать ВМ (от 1 до 9)
    vm_count: 4
    vm_index_list: "{{ range(0, lookup('vars', 'vm_count')) | list }}"

  pre_tasks:
    - name: Get resource pools list from Proxmox
      command: >
        pvesh get /pools  --output-format yaml
      register: proxmox_pool_list
      changed_when: false
      tags: always

    - name: Get VMs list from Proxmox
      command: >
        pvesh get /cluster/resources --type vm  --output-format yaml
      register: proxmox_vm_list
      changed_when: false
      tags: always

  tasks:
    - include_tasks:
        file: vm_create.yml
        apply:
          tags: create
      tags: create

    - include_tasks: vm_dyn_inventory.yml
      tags: dyn_inventory

    - include_tasks: vm_start.yml
      tags: [never, start]

    - include_tasks: vm_shutdown.yml
      tags: [never, shutdown]

    - include_tasks: vm_destroy.yml
      tags: [never, destroy]


- hosts: k8s
  become: yes

  handlers:
    - name: Reboot nodes
      reboot:
        post_reboot_delay: 60
      listen: restart kubelet

  pre_tasks:
    - name: Wait for yum process to exit
      wait_for:
        path: /var/run/yum.pid
        state: absent
        timeout: 600

  tasks:
    - include_tasks: k8s_sysctl.yml
    - include_tasks: k8s_yum.yml
    - include_tasks: k8s_docker.yml
    - include_tasks: k8s_kubernetes.yml


- hosts: k8s_master
  gather_facts: no
  become: yes

  tasks:
    - include_tasks:
        file: deploy_hello_k8s.yml
        apply:
          tags: deploy_hello_k8s
      tags: deploy_hello_k8s
