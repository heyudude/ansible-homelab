# Ansible-Homelab

Репозиторий, в котором собрана конфигурация моих домашних серверов и развернутых на них приложений. И еще некоторые побочные плейбуки и роли, потому что лень создавать отдельный репозиторий и есть зависимости между ролями.

## Использование

* Одна команда для настройки хостов Proxmox, настройки DNS, создания контейнеров LXC и запуска в них сервисов на Docker

      ansible-playbook main.yml

* Чтобы сократить время выполнения, можно запускать отдельные задачи с помощью тегов
  * `pve` - все задачи для хостов Proxmox
  * `pve_common` - отдельная задача для хостов Proxmox
  * `svc` - задачи сразу для всех docker-контейнеров
  * `mgmt` (имя хоста) - задачи для конкретного хоста LXC
  * `portainer` (имя контейнера) - задачи для конкретного docker-контейнера
  * `upgrade_packages` - обновление пакетов на всех хостах LXC
  * `dns` - задачи для DNS-сервера на роутере

        ansible-playbook main.yml -t svc

## Как добавить новое приложение

1. Конфигурация в Ansible
2. Записи DNS в `deploy_homelab_set_static_dns.yml` для локального доступа через Traefik
3. Записи DNS на хостинге для доступа через интернет
4. Прокси хост в `Nginx Proxy Manager`
5. Пользователи в группе приложения в `FreeIPA`

## Команды для кластера Kubernetes

* Одна команда, чтобы сделать всё

      ansible-playbook k8s.yml

* Если кластер уже есть, можно пропустить все шаги настройки и сразу сгенерировать Inventory, установить тестовое приложение в кластере

      ansible-playbook k8s.yml -t dyn_inventory,deploy_hello_k8s

* Завершить работу ВМ

      ansible-playbook k8s.yml -t shutdown

* Запустить ВМ

      ansible-playbook k8s.yml -t start

* Удалить ВМ

      ansible-playbook k8s.yml -t destroy
