---
- name: Get VM status
  vars:
    vm_id: "{{ vm_id_tpl }}{{ item }}"
    vmid_string: "vmid: {{ vm_id }}"
  shell: >
    qm status {{ vm_id }}
  register: vm_status
  loop: "{{ vm_index_list }}"
  changed_when: false
  when: vmid_string in proxmox_vm_list.stdout
  tags: [never, shutdown]

- name: Shutdown VM
  vars:
    vm_id: "{{ vm_id_tpl }}{{ item }}"
    vmid_string: "vmid: {{ vm_id }}"
  shell: >
    qm shutdown {{ vm_id }} && qm wait {{ vm_id }} -timeout 60
  loop: "{{ vm_index_list }}"
  when: > 
    vmid_string in proxmox_vm_list.stdout and
    'stopped' not in vm_status.results[item].stdout
  tags: [never, shutdown]
