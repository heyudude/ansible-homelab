---
- name: Get VM status
  vars:
    vm_id: "{{ vm_id_tpl }}{{ item }}"
    vmid_string: "vmid: {{ vm_id }}"
  shell: >
    qm status {{ vm_id }}
  register: vm_status
  loop: "{{ vm_index_list }}"
  changed_when: false
  when: vmid_string in proxmox_vm_list.stdout
  tags: [never, start]

- name: Start VM
  vars:
    vm_id: "{{ vm_id_tpl }}{{ item }}"
    vmid_string: "vmid: {{ vm_id }}"
  command: >
    qm start {{ vm_id }}
  loop: "{{ vm_index_list }}"
  when: > 
    vmid_string in proxmox_vm_list.stdout and
    'running' not in vm_status.results[item].stdout
  tags: [never, start]

- name: Wait for VM ssh port become available
  vars:
    vm_id: "{{ vm_id_tpl }}{{ item }}"
    vmid_string: "vmid: {{ vm_id }}"
  wait_for:
    host: "{{ vm_net_ip_tpl }}{{ item }}"
    port: 22
  loop: "{{ vm_index_list }}"
  when: > 
    vmid_string in proxmox_vm_list.stdout and
    'running' not in vm_status.results[item].stdout
  tags: [never, start]
